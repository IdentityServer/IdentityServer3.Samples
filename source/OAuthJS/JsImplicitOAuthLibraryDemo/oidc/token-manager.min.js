function Token(n){if(n){if(this.profile=n.profile,this.id_token=n.id_token,this.access_token=n.access_token,n.access_token)this.expires_at=parseInt(n.expires_at);else if(n.id_token)this.expires_at=n.profile.exp;else throw Error("Either access_token or id_token required.");this.scopes=(n.scope||"").split(" ");this.session_state=n.session_state}else this.expires_at=0;Object.defineProperty(this,"expired",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at<n}});Object.defineProperty(this,"expires_in",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at-n}})}function FrameLoader(n){this.url=n}function loadToken(n){var t,i;n._token=null;n._settings.persist&&(t=n._settings.store.getItem(n._settings.persistKey),t&&(i=Token.fromJSON(t),i.expired||(n._token=i)))}function configureTokenExpiring(n){function i(){t=null;n._callTokenExpiring()}function r(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(i,n*1e3)}function u(){if(r(),!n.expired){var t=n.expires_in;t>60?f(t-60):i()}}var t=null;u();n.addOnTokenObtained(u);n.addOnTokenRemoved(r)}function configureAutoRenewToken(n){n._settings.silent_redirect_uri&&n._settings.silent_renew&&n.addOnTokenExpiring(function(){n.renewTokenSilentAsync().catch(function(t){n._callSilentTokenRenewFailed();console.error(t.message||t)})})}function configureTokenExpired(n){function u(){t=null;n._token&&n.saveToken(null);n._callTokenExpired()}function i(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(u,n*1e3)}function r(){i();n.expires_in>0&&f(n.expires_in+1)}var t=null;r();n.addOnTokenObtained(r);n.addOnTokenRemoved(i)}function TokenManager(n){this._settings=n||{};this._settings.persist=this._settings.persist||!0;this._settings.store=this._settings.store||window.localStorage;this._settings.persistKey=this._settings.persistKey||"TokenManager.token";this.oidcClient=new OidcClient(this._settings);this._callbacks={tokenRemovedCallbacks:[],tokenExpiringCallbacks:[],tokenExpiredCallbacks:[],tokenObtainedCallbacks:[],silentTokenRenewFailedCallbacks:[]};Object.defineProperty(this,"profile",{get:function(){if(this._token)return this._token.profile}});Object.defineProperty(this,"id_token",{get:function(){if(this._token)return this._token.id_token}});Object.defineProperty(this,"access_token",{get:function(){if(this._token&&!this._token.expired)return this._token.access_token}});Object.defineProperty(this,"expired",{get:function(){return this._token?this._token.expired:!0}});Object.defineProperty(this,"expires_in",{get:function(){return this._token?this._token.expires_in:0}});Object.defineProperty(this,"expires_at",{get:function(){return this._token?this._token.expires_at:0}});Object.defineProperty(this,"scopes",{get:function(){return this._token?[].concat(this._token.scopes):[]}});Object.defineProperty(this,"session_state",{get:function(){if(this._token)return this._token.session_state}});var t=this;loadToken(t);window.addEventListener("storage",function(n){n.key===t._settings.persistKey&&(loadToken(t),t._token?t._callTokenObtained():t._callTokenRemoved())});configureTokenExpired(t);configureAutoRenewToken(t);window.setTimeout(function(){configureTokenExpiring(t)},0)}var _httpRequest=new DefaultHttpRequest,_promiseFactory=new DefaultPromiseFactory;Token.fromResponse=function(n){if(n.access_token){var t=parseInt(Date.now()/1e3);n.expires_at=t+parseInt(n.expires_in)}return new Token(n)};Token.fromJSON=function(n){if(n)try{var t=JSON.parse(n);return new Token(t)}catch(i){}return new Token(null)};Token.prototype.toJSON=function(){return JSON.stringify({profile:this.profile,id_token:this.id_token,access_token:this.access_token,expires_at:this.expires_at,scope:this.scopes.join(" "),session_state:this.session_state})};FrameLoader.prototype.loadAsync=function(n){return(n=n||this.url,!n)?_promiseFactory.reject("No url provided"):_promiseFactory.create(function(t,i){function f(){window.removeEventListener("message",e,!1);u&&window.clearTimeout(u);u=null;window.document.body.removeChild(r)}function o(){f();i()}function e(n){u&&n.origin===location.protocol+"//"+location.host&&n.source==r.contentWindow&&(f(),t(n.data))}var r=window.document.createElement("iframe"),u;r.style.display="none";r.src=n;u=window.setTimeout(o,5e3);window.addEventListener("message",e,!1);window.document.body.appendChild(r)})};TokenManager.setPromiseFactory=function(n){_promiseFactory=n};TokenManager.setHttpRequest=function(n){if(typeof n!="object"||typeof n.getJSON!="function")throw Error("The provided value is not a valid http request.");_httpRequest=n};TokenManager.prototype._callTokenRemoved=function(){this._callbacks.tokenRemovedCallbacks.forEach(function(n){n()})};TokenManager.prototype._callTokenExpiring=function(){this._callbacks.tokenExpiringCallbacks.forEach(function(n){n()})};TokenManager.prototype._callTokenExpired=function(){this._callbacks.tokenExpiredCallbacks.forEach(function(n){n()})};TokenManager.prototype._callTokenObtained=function(){this._callbacks.tokenObtainedCallbacks.forEach(function(n){n()})};TokenManager.prototype._callSilentTokenRenewFailed=function(){this._callbacks.silentTokenRenewFailedCallbacks.forEach(function(n){n()})};TokenManager.prototype.saveToken=function(n){!n||n instanceof Token||(n=Token.fromResponse(n));this._token=n;this._settings.persist&&!this.expired?this._settings.store.setItem(this._settings.persistKey,n.toJSON()):this._settings.store.removeItem(this._settings.persistKey);n?this._callTokenObtained():this._callTokenRemoved()};TokenManager.prototype.addOnTokenRemoved=function(n){this._callbacks.tokenRemovedCallbacks.push(n)};TokenManager.prototype.addOnTokenObtained=function(n){this._callbacks.tokenObtainedCallbacks.push(n)};TokenManager.prototype.addOnTokenExpiring=function(n){this._callbacks.tokenExpiringCallbacks.push(n)};TokenManager.prototype.addOnTokenExpired=function(n){this._callbacks.tokenExpiredCallbacks.push(n)};TokenManager.prototype.addOnSilentTokenRenewFailed=function(n){this._callbacks.silentTokenRenewFailedCallbacks.push(n)};TokenManager.prototype.removeToken=function(){this.saveToken(null)};TokenManager.prototype.redirectForToken=function(){var n=this.oidcClient;n.createTokenRequestAsync().then(function(n){window.location=n.url},function(n){console.error("TokenManager.redirectForToken error: "+(n&&n.message||n||""))})};TokenManager.prototype.redirectForLogout=function(){var n=this;n.oidcClient.createLogoutRequestAsync(n.id_token).then(function(t){n.removeToken();window.location=t},function(n){console.error("TokenManager.redirectForLogout error: "+(n&&n.message||n||""))})};TokenManager.prototype.processTokenCallbackAsync=function(n){var t=this;return t.oidcClient.processResponseAsync(n).then(function(n){t.saveToken(n)})};TokenManager.prototype.renewTokenSilentAsync=function(){var t=this,n,i;return t._settings.silent_redirect_uri?(n=copy(t._settings),n.redirect_uri=n.silent_redirect_uri,n.prompt="none",i=new OidcClient(n),i.createTokenRequestAsync().then(function(n){var r=new FrameLoader(n.url);return r.loadAsync().then(function(n){return i.processResponseAsync(n).then(function(n){t.saveToken(n)})})})):_promiseFactory.reject("silent_redirect_uri not configured")};TokenManager.prototype.processTokenCallbackSilent=function(n){if(window.top&&window!==window.top){var n=n||window.location.hash;n&&window.top.postMessage(n,location.protocol+"//"+location.host)}};
//# sourceMappingURL=token-manager.min.js.map
