function Token(n,t,i,r,u){if(this.id_token=n,this.id_token_jwt=t,this.access_token=i,i)this.expires_at=parseInt(r);else if(n)this.expires_at=n.exp;else throw Error("Either access_token or id_token required.");Object.defineProperty(this,"expired",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at<n}});Object.defineProperty(this,"expires_in",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at-n}});this.scopes=(u||"").split(" ")}function FrameLoader(n){this.url=n}function loadToken(n){var t,i;n._token=null;n._settings.persist&&(t=n._settings.store.getItem(n._settings.persistKey),t&&(i=Token.fromJSON(t),i.expired||(n._token=i)))}function configureTokenExpiring(n){function i(){t=null;n._callTokenExpiring()}function r(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(i,n*1e3)}function u(){if(r(),!n.expired){var t=n.expires_in;t>60?f(t-60):i()}}var t=null;u();n.addOnTokenObtained(u);n.addOnTokenRemoved(r)}function configureAutoRenewToken(n){n._settings.silent_redirect_uri&&n._settings.silent_renew&&n.addOnTokenExpiring(function(){n.renewTokenSilentAsync().catch(function(t){n._callSilentTokenRenewFailed();console.error(t.message||t)})})}function configureTokenExpired(n){function u(){t=null;n._token&&n.saveToken(null);n._callTokenExpired()}function i(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(u,n*1e3)}function r(){i();n.expires_in>0&&f(n.expires_in+1)}var t=null;r();n.addOnTokenObtained(r);n.addOnTokenRemoved(i)}function TokenManager(n){this._settings=n||{};this._settings.persist=this._settings.persist||!0;this._settings.store=this._settings.store||window.localStorage;this._settings.persistKey=this._settings.persistKey||"TokenManager.token";this._callbacks={tokenRemovedCallbacks:[],tokenExpiringCallbacks:[],tokenExpiredCallbacks:[],tokenObtainedCallbacks:[],silentTokenRenewFailedCallbacks:[]};Object.defineProperty(this,"id_token",{get:function(){if(this._token)return this._token.id_token}});Object.defineProperty(this,"id_token_jwt",{get:function(){if(this._token)return this._token.id_token_jwt}});Object.defineProperty(this,"access_token",{get:function(){if(this._token&&!this._token.expired)return this._token.access_token}});Object.defineProperty(this,"expired",{get:function(){return this._token?this._token.expired:!0}});Object.defineProperty(this,"expires_in",{get:function(){return this._token?this._token.expires_in:0}});Object.defineProperty(this,"expires_at",{get:function(){return this._token?this._token.expires_at:0}});Object.defineProperty(this,"scopes",{get:function(){return this._token?[].concat(this._token.scopes):[]}});var t=this;loadToken(t);window.addEventListener("storage",function(n){n.key===t._settings.persistKey&&(loadToken(t),t._token?t._callTokenObtained():t._callTokenRemoved())});configureTokenExpired(t);configureAutoRenewToken(t);window.setTimeout(function(){configureTokenExpiring(t)},0)}var _httpRequest=new DefaultHttpRequest,_promiseFactory=new DefaultPromiseFactory;Token.fromResponse=function(n){if(n.access_token)var t=parseInt(Date.now()/1e3),i=t+parseInt(n.expires_in);return new Token(n.id_token,n.id_token_jwt,n.access_token,i,n.scope)};Token.fromJSON=function(n){if(n)try{var t=JSON.parse(n);return new Token(t.id_token,t.id_token_jwt,t.access_token,t.expires_at,t.scope)}catch(i){}return new Token(null,0,null)};Token.prototype.toJSON=function(){return JSON.stringify({id_token:this.id_token,id_token_jwt:this.id_token_jwt,access_token:this.access_token,expires_at:this.expires_at,scope:this.scopes.join(" ")})};FrameLoader.prototype.loadAsync=function(n){return(n=n||this.url,!n)?_promiseFactory.reject("No url provided"):_promiseFactory.create(function(t,i){function f(){window.removeEventListener("message",e,!1);r&&window.clearTimeout(r);r=null;u.remove()}function o(){f();i()}function e(n){r&&n.origin===location.protocol+"//"+location.host&&(f(),t(n.data))}var u=$('<iframe style="display:none"><\/iframe>').appendTo("body"),r=window.setTimeout(o,5e3);window.addEventListener("message",e,!1);u.attr("src",n)})};TokenManager.setPromiseFactory=function(n){_promiseFactory=n};TokenManager.setHttpRequest=function(n){if(typeof n!="object"||typeof n.getJSON!="function")throw Error("The provided value is not a valid http request.");_httpRequest=n};TokenManager.prototype._callTokenRemoved=function(){this._callbacks.tokenRemovedCallbacks.forEach(function(n){n()})};TokenManager.prototype._callTokenExpiring=function(){this._callbacks.tokenExpiringCallbacks.forEach(function(n){n()})};TokenManager.prototype._callTokenExpired=function(){this._callbacks.tokenExpiredCallbacks.forEach(function(n){n()})};TokenManager.prototype._callTokenObtained=function(){this._callbacks.tokenObtainedCallbacks.forEach(function(n){n()})};TokenManager.prototype._callSilentTokenRenewFailed=function(){this._callbacks.silentTokenRenewFailedCallbacks.forEach(function(n){n()})};TokenManager.prototype.saveToken=function(n){!n||n instanceof Token||(n=Token.fromResponse(n));this._token=n;this._settings.persist&&!this.expired?this._settings.store.setItem(this._settings.persistKey,n.toJSON()):this._settings.store.removeItem(this._settings.persistKey);n?this._callTokenObtained():this._callTokenRemoved()};TokenManager.prototype.addOnTokenRemoved=function(n){this._callbacks.tokenRemovedCallbacks.push(n)};TokenManager.prototype.addOnTokenObtained=function(n){this._callbacks.tokenObtainedCallbacks.push(n)};TokenManager.prototype.addOnTokenExpiring=function(n){this._callbacks.tokenExpiringCallbacks.push(n)};TokenManager.prototype.addOnTokenExpired=function(n){this._callbacks.tokenExpiredCallbacks.push(n)};TokenManager.prototype.addOnSilentTokenRenewFailed=function(n){this._callbacks.silentTokenRenewFailedCallbacks.push(n)};TokenManager.prototype.removeToken=function(){this.saveToken(null)};TokenManager.prototype.redirectForToken=function(){var n=new OidcClient(this._settings);n.redirectForToken()};TokenManager.prototype.redirectForLogout=function(){var n=new OidcClient(this._settings),t=this.id_token_jwt;this.removeToken();n.redirectForLogout(t)};TokenManager.prototype.createTokenRequestAsync=function(){var n=new OidcClient(this._settings);return n.createTokenRequestAsync()};TokenManager.prototype.processTokenCallbackAsync=function(n){var t=this,i=new OidcClient(t._settings);return i.readResponseAsync(n).then(function(n){t.saveToken(n)})};TokenManager.prototype.renewTokenSilentAsync=function(){var t=this,n,i;return t._settings.silent_redirect_uri?(n=copy(t._settings),n.redirect_uri=n.silent_redirect_uri,n.prompt="none",i=new OidcClient(n),i.createTokenRequestAsync().then(function(n){var r=new FrameLoader(n.url);return r.loadAsync().then(function(n){return i.readResponseAsync(n).then(function(n){t.saveToken(n)})})})):_promiseFactory.reject("silent_redirect_uri not configured")};TokenManager.prototype.processTokenCallbackSilent=function(n){if(window.top&&window!==window.top){var n=n||window.location.hash;n&&window.top.postMessage(n,location.protocol+"//"+location.host)}};
//# sourceMappingURL=token-manager.min.js.map
